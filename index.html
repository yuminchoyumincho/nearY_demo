<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nearY â€” ì‹¤ì‹œê°„ ë°ëª¨ (ë‹¨ì¼ ìˆ˜ë½/ê±°ì ˆ ë°˜ì˜)</title>
<style>
  :root{ --navy:#183857; --bg:#f6f8fb; --card:#fff; --sub:#64748b; --pill:#e9eff7; }
  *{ box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, 'Apple SD Gothic Neo', sans-serif }
  body{ margin:0; background:var(--bg); color:#0f172a }
  header{ padding:14px 16px; background:var(--navy); color:#fff; display:flex; justify-content:space-between; align-items:center }
  header h1{ font-size:16px; margin:0; font-weight:800 }
  .container{ padding:16px; max-width:960px; margin:0 auto }
  .card{ background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:14px }
  label{ display:block; font-size:12px; color:#64748b; margin:10px 0 6px }
  input[type=text], select, textarea{ width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff }
  textarea{ min-height:84px }
  .row{ display:flex; gap:12px; flex-wrap:wrap }
  .row>div{ flex:1; min-width:200px }
  .btn{ display:inline-flex; justify-content:center; align-items:center; min-width:140px; padding:12px 16px; border-radius:12px; background:var(--navy); color:#fff; border:none; font-weight:800; cursor:pointer }
  .btn.secondary{ background:#fff; color:#183857; border:1px solid #d1d5db }
  .btn.small{ min-width:auto; padding:8px 10px; font-weight:700 }
  .muted{ color:#64748b; font-size:13px }
  .space{ height:10px }
  .list{ display:grid; gap:10px }
  .item{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px }
  .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#e9eff7; color:#183857; font-size:12px }
  .tiny{ font-size:12px }
  .warning{ background:#fff7ed; color:#9a3412; border:1px solid #fcd34d; padding:10px; border-radius:8px }
  .ok{ background:#ecfdf5; color:#065f46; border:1px solid #34d399; padding:10px; border-radius:8px }
  .error{ color:#b91c1c; font-size:12px; margin-top:6px }
  .hidden{ display:none !important }
</style>
</head>
<body>
<header>
  <h1>nearY â€” ì‹¤ì‹œê°„ ë°ëª¨</h1>
  <div class="tiny">ë¡œê·¸ì¸ â†’ í”„ë¡œí•„ â†’ ì—­í•  â†’ ë‹¨ì¼í™”ë©´ / ì²« ìˆ˜ë½ë§Œ ìœ íš¨</div>
</header>

<div class="container">

  <!-- A. ë¡œê·¸ì¸ -->
  <section id="scr-login" class="card">
    <h3 style="margin:0 0 8px 0">A. ì¬í•™ìƒ ë¡œê·¸ì¸ (ë°ëª¨)</h3>
    <label>ì—°ì„¸ ë©”ì¼</label>
    <input id="email" placeholder="you@yonsei.ac.kr" />
    <div class="space"></div>
    <button class="btn" id="btnVerify">ë¡œê·¸ì¸</button>
    <div id="msgLogin" class="space tiny"></div>
  </section>

  <!-- B. í”„ë¡œí•„ -->
  <section id="scr-profile" class="card hidden">
    <h3 style="margin:0 0 8px 0">B. í”„ë¡œí•„</h3>
    <div class="row">
      <div>
        <label>ì´ë¦„/ë‹‰ë„¤ì„</label>
        <input id="nickname" placeholder="ì˜ˆ: ì—°ëŒ€ìš©ì‚¬" />
      </div>
      <div>
        <label>ì„±ë³„</label>
        <select id="gender">
          <option value="F">F</option>
          <option value="M">M</option>
        </select>
      </div>
    </div>
    <div class="space"></div>
    <button class="btn" id="btnSaveProfile">ì €ì¥í•˜ê³  ë‹¤ìŒ</button>
    <div id="msgProfile" class="space tiny"></div>
  </section>

  <!-- C. ì—­í•  ì„ íƒ -->
  <section id="scr-role" class="card hidden">
    <h3 style="margin:0 0 8px 0">C. ì—­í•  ì„ íƒ</h3>
    <div class="row">
      <button class="btn" id="chooseRider">ì´ë™ì•½ì</button>
      <button class="btn" id="chooseHelper">ë„ìš°ë¯¸</button>
    </div>
    <div class="space"></div>
    <div class="muted tiny">ì„ íƒí•˜ë©´ í•´ë‹¹ ì—­í•  í™”ë©´ë§Œ ë³´ì…ë‹ˆë‹¤.</div>
  </section>

  <!-- D. ì´ë™ì•½ì -->
  <section id="scr-rider" class="card hidden">
    <h3 style="margin:0 0 8px 0">ì´ë™ì•½ì â€” ë„ì›€ ìš”ì²­</h3>
    <div class="row">
      <div>
        <label>ì¶œë°œì§€ ì¡´</label>
        <select id="r_from"></select>
      </div>
      <div>
        <label>ëª©ì ì§€ ì¡´</label>
        <select id="r_to"></select>
      </div>
    </div>
    <label>ìš”ì²­ ë©”ëª¨</label>
    <textarea id="r_memo" placeholder="ì—˜ë¦¬ë² ì´í„° ì„ í˜¸ ë“±"></textarea>
    <div class="space"></div>
    <button class="btn" id="r_send">ìš”ì²­ ë³´ë‚´ê¸°</button>
    <div id="r_msg" class="space tiny"></div>

    <div class="space"></div>
    <h4>ì—¬ì • ìƒíƒœ</h4>
    <div id="r_tripState" class="tiny muted">-</div>
    <div class="space"></div>
    <button class="btn secondary" id="r_arrive">ë„ì°© (PIN ì…ë ¥)</button>
  </section>

  <!-- E. ë„ìš°ë¯¸ -->
  <section id="scr-helper" class="card hidden">
    <h3 style="margin:0 0 8px 0">ë„ìš°ë¯¸ â€” ìš”ì²­ ìˆ˜ì‹ í•¨</h3>
    <div class="row">
      <div>
        <label>ë‚´ í˜„ì¬ ì¡´</label>
        <select id="h_zone"></select>
      </div>
      <div>
        <label>êµìœ¡/í€´ì¦ˆ</label>
        <div style="display:flex; gap:8px">
          <button class="btn secondary small" id="h_pass">í€´ì¦ˆ í•©ê²© ì²˜ë¦¬</button>
          <div id="h_state" class="muted tiny" style="align-self:center">ë¯¸í•©ê²© (ìˆ˜ë½ ë¶ˆê°€)</div>
        </div>
      </div>
    </div>

    <div class="space"></div>
    <h4>ë„ì°©í•œ ìš”ì²­ (ê°™ì€/ì¸ì ‘ ì¡´ë§Œ í‘œì‹œ)</h4>
    <div id="h_inbox" class="list tiny muted">ëŒ€ê¸° ì¤‘â€¦</div>
    <div id="h_err" class="error"></div>

    <div class="space"></div>
    <h4>í˜„ì¬ ì—¬ì • ìƒíƒœ</h4>
    <div id="h_tripState" class="tiny muted">-</div>
  </section>
</div>

<!-- Firebase CDN -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, onSnapshot,
    query, where, updateDoc, serverTimestamp, setDoc,
    runTransaction, arrayUnion
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  /* ë„¤ í”„ë¡œì íŠ¸ ì„¤ì • */
  const firebaseConfig = {
    apiKey: "AIzaSyAq1ICIJgBPCXb6huCqKnJRYrM8bvYr3jM",
    authDomain: "neary-demo-3b3c6.firebaseapp.com",
    projectId: "neary-demo-3b3c6",
    storageBucket: "neary-demo-3b3c6.firebasestorage.app",
    messagingSenderId: "294237201199",
    appId: "1:294237201199:web:18d15eda48ba0aff2277da"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ìœ í‹¸ */
  const $ = s => document.querySelector(s);
  const show = id => $(id).classList.remove('hidden');
  const hide = id => $(id).classList.add('hidden');
  const fill = (sel, arr)=> sel.innerHTML = arr.map(z=>`<option value="${z}">${z}</option>`).join('');

  /* ë§¤ ë°©ë¬¸ ìƒˆ ì„¸ì…˜ */
  localStorage.removeItem('nearY');

  /* ê°„ë‹¨ ìŠ¤í† ë¦¬ì§€ */
  const Store = {
    g(){ return JSON.parse(localStorage.getItem('nearY')||'{}'); },
    s(o){ localStorage.setItem('nearY', JSON.stringify(o)); },
    set(k,v){ const o=this.g(); o[k]=v; this.s(o); },
    get(k,d=null){ const o=this.g(); return k in o? o[k]:d; }
  };
  const uid = Math.random().toString(36).slice(2)+Date.now().toString(36);
  Store.set('uid', uid);

  /* ì¡´ */
  const ZONES=["ENG","LIB","BAEK","SCI","MED","DORM","MAIN","LAW","ECO","MUSE"];
  const ADJ={ ENG:["LIB","SCI","MAIN"], LIB:["ENG","BAEK","MAIN"], BAEK:["LIB","MAIN"], SCI:["ENG","MED"], MED:["SCI"], DORM:["MAIN"], MAIN:["ENG","LIB","BAEK","DORM","LAW","ECO"], LAW:["MAIN"], ECO:["MAIN"], MUSE:["MAIN"] };
  const isNear=(a,b)=> (a===b)|| (ADJ[a]||[]).includes(b) || (ADJ[b]||[]).includes(a);
  fill($('#r_from'),ZONES); fill($('#r_to'),ZONES); fill($('#h_zone'),ZONES);

  /* í™”ë©´ ì „í™˜ */
  function goto(scrId){ ['#scr-login','#scr-profile','#scr-role','#scr-rider','#scr-helper'].forEach(id=>hide(id)); show(scrId); }

  /* A. ë¡œê·¸ì¸ */
  $('#btnVerify').onclick=()=>{
    const email=$('#email').value.trim();
    if(!/@yonsei\.ac\.kr$/.test(email)){ $('#msgLogin').innerHTML=`<div class="warning">ì—°ì„¸ ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</div>`; return; }
    Store.set('email',email);
    $('#msgLogin').innerHTML=`<div class="ok">ë¡œê·¸ì¸ ì„±ê³µ</div>`;
    setTimeout(()=>goto('#scr-profile'),300);
  };

  /* B. í”„ë¡œí•„ */
  $('#btnSaveProfile').onclick=()=>{
    const n=$('#nickname').value.trim(); const g=$('#gender').value;
    if(!n){ $('#msgProfile').innerHTML=`<div class="warning">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.</div>`; return; }
    Store.set('nickname',n); Store.set('gender',g);
    $('#msgProfile').innerHTML=`<div class="ok">ì €ì¥ì™„ë£Œ</div>`;
    setTimeout(()=>goto('#scr-role'),300);
  };

  /* C. ì—­í•  */
  $('#chooseRider').onclick=()=>{ Store.set('role','rider'); startRider(); goto('#scr-rider'); };
  $('#chooseHelper').onclick=()=>{ Store.set('role','helper'); startHelper(); goto('#scr-helper'); };

  /* ì»¬ë ‰ì…˜ */
  const COL_REQ = collection(db,'requests');
  const COL_HELP= collection(db,'helperStates');

  /* D. ì´ë™ì•½ì */
  let riderReqId = null;
  function startRider(){
    // ë‚´ ìš”ì²­ ë‹¨ì¼ ë¬¸ì„œ ì‹¤ì‹œê°„ êµ¬ë…
    const watchMyRequest = (reqId)=>{
      riderReqId = reqId;
      const ref = doc(db,'requests',reqId);
      onSnapshot(ref, snap=>{
        if(!snap.exists()) return;
        const v = snap.data();
        // ìƒíƒœ UI
        if(v.status === 'OPEN'){
          $('#r_tripState').textContent = 'ìš”ì²­ ëŒ€ê¸° ì¤‘';
          $('#r_msg').innerHTML = `<div class="ok">ìš”ì²­ ì „ì†¡ë¨</div>`;
        }else if(v.status === 'ACCEPTED'){
          $('#r_tripState').textContent = `ë„ìš°ë¯¸ ìˆ˜ë½: ${v.acceptedHelperName||'ë„ìš°ë¯¸'} (1ëª…)`;
          $('#r_msg').innerHTML = `<div class="ok">${v.acceptedHelperName||'ë„ìš°ë¯¸'}ë‹˜ì´ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤</div>`;
        }else if(v.status === 'DONE'){
          $('#r_tripState').textContent = 'ë„ì°© ì™„ë£Œ';
          $('#r_msg').innerHTML = `<div class="ok">ì—¬ì •ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div>`;
        }else{
          $('#r_tripState').textContent = v.status || '-';
        }
      });
    };

    // ê¸°ì¡´ ìš”ì²­ì´ ìˆë‹¤ë©´ ê³„ì† êµ¬ë…
    const existing = Store.get('currentReq', null);
    if(existing) watchMyRequest(existing);

    // ë³´ë‚´ê¸° ë²„íŠ¼
    $('#r_send').onclick = async ()=>{
      const from=$('#r_from').value, to=$('#r_to').value, memo=$('#r_memo').value.trim();
      const ref = await addDoc(COL_REQ, {
        riderId: uid,
        riderName: Store.get('nickname','ìµëª…'),
        riderGender: Store.get('gender','F'),
        from, to, memo,
        status: 'OPEN',
        rejectedBy: [],
        createdAt: serverTimestamp()
      });
      Store.set('currentReq', ref.id);
      watchMyRequest(ref.id);
    };

    // ë„ì°© ì²˜ë¦¬
    $('#r_arrive').onclick = async ()=>{
      const pin=prompt('ë„ì°© PIN (ë°ëª¨: 1234)');
      if(pin!=='1234'){ alert('PIN ë¶ˆì¼ì¹˜'); return; }
      const reqId = Store.get('currentReq', null);
      if(!reqId){ alert('ìš”ì²­ ì—†ìŒ'); return; }
      await updateDoc(doc(db,'requests',reqId), { status:'DONE', finishedAt:serverTimestamp() });
      alert('ê°ì‚¬í•©ë‹ˆë‹¤!');
    };
  }

  /* E. ë„ìš°ë¯¸ */
  let helperUnsub=null;
  function subscribeHelperInbox(){
    const inbox=$('#h_inbox'); const errBox=$('#h_err'); errBox.textContent='';
    // OPENë§Œ êµ¬ë… (ìˆ˜ë½ ì‹œ ë°”ë¡œ ì‚¬ë¼ì§)
    const q = query(COL_REQ, where('status','==','OPEN'));
    if(helperUnsub) helperUnsub();

    helperUnsub = onSnapshot(
      q,
      (snap)=>{
        const zone=$('#h_zone').value||'MAIN';
        let out='';
        snap.forEach(d=>{
          const v=d.data();
          // ë‚´ê°€ ê±°ì ˆí•œ ìš”ì²­ì€ ìˆ¨ê¹€
          if(Array.isArray(v.rejectedBy) && v.rejectedBy.includes(uid)) return;
          // ê°™ì€/ì¸ì ‘ ì¡´ë§Œ
          if(!isNear(zone, v.from)) return;

          const acceptBtn = Store.get('passed')
            ? `<button class="btn small" data-accept="${d.id}">ìˆ˜ë½</button>`
            : `<button class="btn small" disabled>ìˆ˜ë½(í€´ì¦ˆ í•„ìš”)</button>`;

          // ì´ë™ì•½ì ë‹‰ë„¤ì„ì„ ì¹´ë“œì— ëª…í™•íˆ í‘œì‹œ
          const riderName = v.riderName || 'ìµëª…';

          out+=`<div class="item">
                  <div><b>${riderName}</b> ë‹˜ì˜ ìš”ì²­ Â· <span class="pill">${v.from||'-'}</span> â†’ <b>${v.to||'-'}</b></div>
                  <div class="space"></div>
                  <div class="muted tiny">${v.memo||'-'}</div>
                  <div class="space"></div>
                  <div style="display:flex; gap:8px">${acceptBtn}
                    <button class="btn secondary small" data-reject="${d.id}">ê±°ì ˆ</button>
                  </div>
                </div>`;
        });
        inbox.innerHTML = out || 'í‘œì‹œí•  ìš”ì²­ ì—†ìŒ';
      },
      (error)=>{
        errBox.textContent = 'êµ¬ë… ì—ëŸ¬: ' + error.message;
        inbox.innerHTML = 'í‘œì‹œí•  ìš”ì²­ ì—†ìŒ';
      }
    );
  }

  function startHelper(){
    setDoc(doc(db,'helperStates', uid),{
      uid,email:Store.get('email'),nickname:Store.get('nickname'),gender:Store.get('gender'),
      zone:$('#h_zone').value, passed:Store.get('passed')||false, updatedAt:serverTimestamp()
    },{merge:true});
    subscribeHelperInbox();
  }

  $('#h_zone').onchange=async()=>{
    Store.set('h_zone',$('#h_zone').value);
    await setDoc(doc(db,'helperStates',uid),{ zone:$('$h_zone').value, updatedAt:serverTimestamp() },{merge:true});
    subscribeHelperInbox();
  };
  $('#h_pass').onclick=async()=>{
    Store.set('passed',true);
    $('#h_state').textContent='í€´ì¦ˆ í•©ê²©ë¨ Â· ìˆ˜ë½ ê°€ëŠ¥';
    await setDoc(doc(db,'helperStates',uid),{ passed:true },{merge:true});
  };

  // ìˆ˜ë½/ê±°ì ˆ ì²˜ë¦¬
  $('#h_inbox').onclick=async e=>{
    const acceptId=e.target?.getAttribute('data-accept');
    const rejectId=e.target?.getAttribute('data-reject');

    if(acceptId){
      if(!Store.get('passed')){ alert('í€´ì¦ˆ í•©ê²© í•„ìš”'); return; }

      try{
        // ğŸ”’ ë‹¨ í•œ ëª…ë§Œ ìˆ˜ë½: íŠ¸ëœì­ì…˜ìœ¼ë¡œ ìƒíƒœ OPEN â†’ ACCEPTED
        await runTransaction(db, async (tx)=>{
          const ref = doc(db,'requests',acceptId);
          const snap = await tx.get(ref);
          if(!snap.exists()) throw new Error('ìš”ì²­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
          const v = snap.data();
          if(v.status !== 'OPEN') throw new Error('ì´ë¯¸ ë‹¤ë¥¸ ë„ìš°ë¯¸ê°€ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤');

          tx.update(ref, {
            status: 'ACCEPTED',
            acceptedHelperId: uid,
            acceptedHelperName: Store.get('nickname','ë„ìš°ë¯¸'),
            acceptedAt: serverTimestamp()
          });
        });

        $('#h_tripState').textContent='ìˆ˜ë½ ì™„ë£Œ (ì´ë™ì•½ì ì¸¡ì— ì•Œë¦¼)';
        // OPEN êµ¬ë…ì´ë¯€ë¡œ ìˆ˜ë½ ì§í›„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìë™ ì œê±°ë¨
      }catch(err){
        alert(err.message || 'ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜');
      }
    }

    if(rejectId){
      // ì´ ë„ìš°ë¯¸ë§Œ ìˆ¨ê¸°ê¸°
      await updateDoc(doc(db,'requests',rejectId), { rejectedBy: arrayUnion(uid) });
      // ë¡œì»¬ ì¦‰ì‹œ ë°˜ì˜ì€ onSnapshotì— ì˜í•´ ìë™ ì²˜ë¦¬ë¨(ë‹¤ìŒ ìŠ¤ëƒ…ìƒ·ì—ì„œ í•„í„°ë¨)
    }
  };

  /* ë¶€íŒ… */
  goto('#scr-login');
</script>
</body>
</html>
