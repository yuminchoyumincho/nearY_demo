<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nearY — 실시간 데모 (로그인 → 역할별 단일화면)</title>
<style>
  :root{ --navy:#183857; --bg:#f6f8fb; --card:#fff; --sub:#64748b; --pill:#e9eff7; }
  *{ box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans KR', Arial, 'Apple SD Gothic Neo', sans-serif }
  body{ margin:0; background:var(--bg); color:#0f172a }
  header{ padding:14px 16px; background:var(--navy); color:#fff; display:flex; justify-content:space-between; align-items:center }
  header h1{ font-size:16px; margin:0; font-weight:800 }
  .container{ padding:16px; max-width:960px; margin:0 auto }
  .card{ background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:14px }
  label{ display:block; font-size:12px; color:var(--sub); margin:10px 0 6px }
  input[type=text], select, textarea{ width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff }
  textarea{ min-height:84px }
  .row{ display:flex; gap:12px; flex-wrap:wrap }
  .row>div{ flex:1; min-width:200px }
  .btn{ display:inline-flex; justify-content:center; align-items:center; min-width:140px; padding:12px 16px; border-radius:12px; background:var(--navy); color:#fff; border:none; font-weight:800; cursor:pointer }
  .btn.secondary{ background:#fff; color:var(--navy); border:1px solid #d1d5db }
  .btn.small{ min-width:auto; padding:8px 10px; font-weight:700 }
  .muted{ color:#64748b; font-size:13px }
  .space{ height:10px }
  .list{ display:grid; gap:10px }
  .item{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px }
  .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:var(--pill); color:#183857; font-size:12px }
  .tiny{ font-size:12px }
  .warning{ background:#fff7ed; color:#9a3412; border:1px solid #fcd34d; padding:10px; border-radius:8px }
  .ok{ background:#ecfdf5; color:#065f46; border:1px solid #34d399; padding:10px; border-radius:8px }
  .hidden{ display:none !important }
</style>
</head>
<body>
<header>
  <h1>nearY — 실시간 데모</h1>
  <div class="tiny">로그인 → 프로필 → 역할 → 단일화면 / Firestore 실시간</div>
</header>

<div class="container">

  <!-- 화면 1: 로그인 -->
  <section id="scr-login" class="card">
    <h3 style="margin:0 0 8px 0">A. 재학생 로그인 (데모)</h3>
    <label>연세 메일</label>
    <input id="email" placeholder="you@yonsei.ac.kr" />
    <div class="space"></div>
    <button class="btn" id="btnVerify">로그인</button>
    <div id="msgLogin" class="space tiny"></div>
  </section>

  <!-- 화면 2: 프로필 -->
  <section id="scr-profile" class="card hidden">
    <h3 style="margin:0 0 8px 0">B. 프로필</h3>
    <div class="row">
      <div>
        <label>이름/닉네임</label>
        <input id="nickname" placeholder="예: 연대용사" />
      </div>
      <div>
        <label>성별</label>
        <select id="gender">
          <option value="F">F</option>
          <option value="M">M</option>
        </select>
      </div>
    </div>
    <div class="space"></div>
    <button class="btn" id="btnSaveProfile">저장하고 다음</button>
    <div id="msgProfile" class="space tiny"></div>
  </section>

  <!-- 화면 3: 역할 선택 -->
  <section id="scr-role" class="card hidden">
    <h3 style="margin:0 0 8px 0">C. 역할 선택</h3>
    <div class="row">
      <button class="btn" id="chooseRider">이동약자</button>
      <button class="btn" id="chooseHelper">도우미</button>
    </div>
    <div class="space"></div>
    <div class="muted tiny">선택하면 해당 역할 화면만 보입니다.</div>
  </section>

  <!-- 화면 4: 이동약자 단일화면 -->
  <section id="scr-rider" class="card hidden">
    <h3 style="margin:0 0 8px 0">이동약자 — 도움 요청</h3>
    <div class="row">
      <div>
        <label>출발지 존</label>
        <select id="r_from"></select>
      </div>
      <div>
        <label>목적지 존</label>
        <select id="r_to"></select>
      </div>
    </div>
    <label>요청 메모</label>
    <textarea id="r_memo" placeholder="엘리베이터 선호 등"></textarea>
    <div class="space"></div>
    <button class="btn" id="r_send">요청 보내기</button>
    <div id="r_msg" class="space tiny"></div>

    <div class="space"></div>
    <h4>수락한 도우미 후보</h4>
    <div id="r_candidates" class="list tiny muted">아직 후보 없음</div>

    <div class="space"></div>
    <h4>여정 상태</h4>
    <div id="r_tripState" class="tiny muted">-</div>
    <div class="space"></div>
    <button class="btn secondary" id="r_arrive">도착 (PIN 입력)</button>
  </section>

  <!-- 화면 5: 도우미 단일화면 -->
  <section id="scr-helper" class="card hidden">
    <h3 style="margin:0 0 8px 0">도우미 — 요청 수신함</h3>
    <div class="row">
      <div>
        <label>내 현재 존</label>
        <select id="h_zone"></select>
      </div>
      <div>
        <label>교육/퀴즈</label>
        <div style="display:flex; gap:8px">
          <button class="btn secondary small" id="h_pass">퀴즈 합격 처리</button>
          <div id="h_state" class="muted tiny" style="align-self:center">미합격 (수락 불가)</div>
        </div>
      </div>
    </div>

    <div class="space"></div>
    <h4>도착한 요청 (같은/인접 존만 표시)</h4>
    <div id="h_inbox" class="list tiny muted">대기 중…</div>

    <div class="space"></div>
    <h4>현재 여정 상태</h4>
    <div id="h_tripState" class="tiny muted">-</div>
  </section>

  <section class="card tiny muted">
    <b>Self-XSS 주의:</b> 이 코드를 콘솔에 붙여넣지 말고, 파일로 저장해 URL로 여세요.
  </section>
</div>

<!-- Firebase: CDN 모듈 사용 (npm import 아님) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, where, updateDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  /* 네가 보낸 firebaseConfig 적용 */
  const firebaseConfig = {
    apiKey: "AIzaSyAq1ICIJgBPCXb6huCqKnJRYrM8bvYr3jM",
    authDomain: "neary-demo-3b3c6.firebaseapp.com",
    projectId: "neary-demo-3b3c6",
    storageBucket: "neary-demo-3b3c6.firebasestorage.app",
    messagingSenderId: "294237201199",
    appId: "1:294237201199:web:18d15eda48ba0aff2277da"
  };

  /* initializeApp 은 반드시 필요합니다 */
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* 유틸 */
  const $ = s => document.querySelector(s);
  const show = id => $(id).classList.remove('hidden');
  const hide = id => $(id).classList.add('hidden');
  const fill = (sel, arr)=> sel.innerHTML = arr.map(z=>`<option value="${z}">${z}</option>`).join('');

  /* 간단 스토리지 */
  const Store = {
    g(){ return JSON.parse(localStorage.getItem('nearY')||'{}'); },
    s(o){ localStorage.setItem('nearY', JSON.stringify(o)); },
    set(k,v){ const o=this.g(); o[k]=v; this.s(o); },
    get(k,d=null){ const o=this.g(); return k in o? o[k]:d; }
  };

  /* ✅ 항상 새로운 사용자 세션을 생성하도록 변경 */
  const uid = Math.random().toString(36).slice(2) + Date.now().toString(36);
  Store.set('uid', uid); // 항상 새로 생성
  Store.set('email', null);
  Store.set('role', null);
  
  /* 존 & 근접판정(500m 대체) */
  const ZONES=["ENG","LIB","BAEK","SCI","MED","DORM","MAIN","LAW","ECO","MUSE"];
  const ADJ={ ENG:["LIB","SCI","MAIN"], LIB:["ENG","BAEK","MAIN"], BAEK:["LIB","MAIN"], SCI:["ENG","MED"], MED:["SCI"], DORM:["MAIN"], MAIN:["ENG","LIB","BAEK","DORM","LAW","ECO"], LAW:["MAIN"], ECO:["MAIN"], MUSE:["MAIN"] };
  const isNear=(a,b)=> (a===b)|| (ADJ[a]||[]).includes(b) || (ADJ[b]||[]).includes(a);

  /* 셀렉트 채우기 */
  fill($('#r_from'),ZONES); fill($('#r_to'),ZONES); fill($('#h_zone'),ZONES);

  /* 화면 전환 로직 */
  function goto(scrId){
    ['#scr-login','#scr-profile','#scr-role','#scr-rider','#scr-helper'].forEach(id=>hide(id));
    show(scrId);
  }

  /* A. 로그인 */
  $('#btnVerify').onclick=()=>{
    const email=$('#email').value.trim();
    if(!/@yonsei\.ac\.kr$/.test(email)){ $('#msgLogin').innerHTML=`<div class="warning">연세 메일 형식이 아닙니다.</div>`; return; }
    Store.set('email',email);
    $('#msgLogin').innerHTML=`<div class="ok">로그인 성공</div>`;
    setTimeout(()=>goto('#scr-profile'),400);
  };

  /* B. 프로필 */
  $('#btnSaveProfile').onclick=()=>{
    const n=$('#nickname').value.trim(); const g=$('#gender').value;
    if(!n){ $('#msgProfile').innerHTML=`<div class="warning">닉네임을 입력하세요.</div>`; return; }
    Store.set('nickname',n); Store.set('gender',g);
    $('#msgProfile').innerHTML=`<div class="ok">저장완료</div>`;
    setTimeout(()=>goto('#scr-role'),400);
  };

  /* C. 역할 선택 → 단일 화면 */
  $('#chooseRider').onclick=()=>{ Store.set('role','rider'); startRider(); goto('#scr-rider'); };
  $('#chooseHelper').onclick=()=>{ Store.set('role','helper'); startHelper(); goto('#scr-helper'); };

  /* Firestore 컬렉션 */
  const COL_REQ=collection(db,'requests');     // 요청
  const COL_CAND=collection(db,'candidates');  // 후보(수락)
  const COL_HELP=collection(db,'helperStates');// 도우미 상태(옵션)

  /* D-1. 이동약자 */
  function startRider(){
    // 내 요청에 대한 후보 실시간 감시
    onSnapshot(COL_CAND, snap=>{
      const mine=Store.get('currentReq',null);
      const box=$('#r_candidates');
      if(!mine){ box.textContent='아직 요청하지 않았습니다'; return; }
      let out='';
      snap.forEach(d=>{
        const v=d.data();
        if(v.requestId!==mine) return;
        out+=`<div class="item">
                <div><b>${v.helperName||'도우미'}</b> <span class="pill">후보</span></div>
                <div class="space"></div>
                <button class="btn small" data-pick="${d.id}" data-req="${mine}">이 도우미 선택</button>
              </div>`;
      });
      box.innerHTML = out || '아직 도우미가 수락하지 않았습니다';
    });
  }
  $('#r_send').onclick=async()=>{
    const from=$('#r_from').value, to=$('#r_to').value, memo=$('#r_memo').value.trim();
    const ref=await addDoc(COL_REQ,{
      riderId:uid, riderName:Store.get('nickname','익명'), riderGender:Store.get('gender','F'),
      from,to,memo,status:'OPEN',createdAt:serverTimestamp()
    });
    Store.set('currentReq',ref.id);
    $('#r_msg').innerHTML=`<div class="ok">요청 전송됨</div>`;
    $('#r_tripState').textContent='요청 대기 중';
  };
  $('#r_candidates').onclick=async e=>{
    const pick=e.target?.getAttribute('data-pick'); const req=e.target?.getAttribute('data-req');
    if(pick&&req){
      await updateDoc(doc(db,'requests',req),{ status:'ONGOING', pickedCandidate:pick, startedAt:serverTimestamp() });
      $('#r_tripState').textContent='동행 중';
    }
  };
  $('#r_arrive').onclick=async()=>{
    const pin=prompt('도착 PIN (데모: 1234)');
    if(pin!=='1234'){ alert('PIN 불일치'); return; }
    const req=Store.get('currentReq',null); if(!req){ alert('요청 없음'); return; }
    await updateDoc(doc(db,'requests',req),{ status:'DONE', finishedAt:serverTimestamp() });
    $('#r_tripState').textContent='도착 완료';
    alert('감사합니다!');
  };

  /* D-2. 도우미 */
  let helperUnsub=null;
  function startHelper(){
    // 최초 상태 기록
    setDoc(doc(db,'helperStates',uid),{
      uid,email:Store.get('email'),nickname:Store.get('nickname'),gender:Store.get('gender'),
      zone:$('#h_zone').value, passed:Store.get('passed')||false, updatedAt:serverTimestamp()
    },{merge:true});

    // OPEN 요청만 실시간 구독
    const q=query(COL_REQ, where('status','==','OPEN'), orderBy('createdAt','desc'));
    if(helperUnsub) helperUnsub();
    helperUnsub=onSnapshot(q,snap=>{
      const zone=$('#h_zone').value||'MAIN';
      let out='';
      snap.forEach(d=>{
        const v=d.data();
        if(!isNear(zone,v.from)) return; // 같은/인접 존만
        const acceptBtn = Store.get('passed')
          ? `<button class="btn small" data-accept="${d.id}">수락</button>`
          : `<button class="btn small" disabled>수락(퀴즈 필요)</button>`;
        out+=`<div class="item">
                <div><b>${v.from}</b> → <b>${v.to}</b> <span class="pill" style="float:right">요청</span></div>
                <div class="space"></div>
                <div class="muted tiny">${v.memo||'-'} · by ${v.riderName||'익명'}</div>
                <div class="space"></div>
                <div style="display:flex; gap:8px">${acceptBtn}
                  <button class="btn secondary small" data-reject="${d.id}">거절</button></div>
              </div>`;
      });
      $('#h_inbox').innerHTML = out || '표시할 요청 없음';
    });
  }
  $('#h_zone').onchange=async()=>{
    Store.set('h_zone',$('#h_zone').value);
    await setDoc(doc(db,'helperStates',uid),{ zone:$('#h_zone').value, updatedAt:serverTimestamp() },{merge:true});
    startHelper();
  };
  $('#h_pass').onclick=async()=>{
    Store.set('passed',true);
    $('#h_state').textContent='퀴즈 합격됨 · 수락 가능';
    await setDoc(doc(db,'helperStates',uid),{ passed:true },{merge:true});
  };
  $('#h_inbox').onclick=async e=>{
    const a=e.target?.getAttribute('data-accept');
    const r=e.target?.getAttribute('data-reject');
    if(a){
      if(!Store.get('passed')){ alert('퀴즈 합격 필요'); return; }
      await addDoc(COL_CAND,{ requestId:a, helperId:uid, helperName:Store.get('nickname','도우미'), createdAt:serverTimestamp() });
      $('#h_tripState').textContent='수락됨 (이동약자 확인 중)';
    }
    if(r){ alert('거절 처리(데모)'); }
  };

  /* 기존 선택 복원 (새로고침 대비) */
  if(Store.get('role')==='rider') startRider();
  if(Store.get('role')==='helper') startHelper();

  /* 첫 진입 분기 — 저장된 상태가 있으면 자동 진행 */
  (function boot(){
    const email=Store.get('email'); const nick=Store.get('nickname'); const role=Store.get('role');
    if(!email) goto('#scr-login');
    else if(!nick) goto('#scr-profile');
    else if(!role) goto('#scr-role');
    else goto(role==='rider' ? '#scr-rider' : '#scr-helper');
    if(Store.get('passed')) $('#h_state').textContent='퀴즈 합격됨 · 수락 가능';
    if(Store.get('h_zone')) $('#h_zone').value=Store.get('h_zone');
    if(Store.get('currentReq')) $('#r_tripState').textContent='요청 보냄 (대기 중)';
  })();
</script>
</body>
</html>
